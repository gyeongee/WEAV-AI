# WEAV AI 백엔드 인프라 - 프로덕션급 Docker Compose 설정
# 맥미니 + 외장하드 + Cloudflare Tunnel 기반

name: weavai  # 프로젝트 이름 (컨테이너 그룹명)

# 내부 네트워크 정의 (서비스 간 통신용)
networks:
  weavai_network:
    driver: bridge

# 볼륨 정의
volumes:
  postgres_data:
    driver: local
  # minio_data는 직접 경로 마운트로 변경 (Docker Desktop for Mac 호환성)

services:
  # ===== 데이터베이스 레이어 =====

  # PostgreSQL - 영속 데이터 저장소
  postgres:
    image: postgres:15-alpine
    container_name: weavai_postgres
    restart: unless-stopped
    networks:
      - weavai_network
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-weavai}
      POSTGRES_USER: ${POSTGRES_USER:-weavai_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_this_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # 호스트 포트 노출하지 않음 (보안)
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-weavai_user} -d ${POSTGRES_DB:-weavai}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis - Celery 브로커 및 캐시
  redis:
    image: redis:7-alpine
    container_name: weavai_redis
    restart: unless-stopped
    networks:
      - weavai_network
    command: redis-server --appendonly yes
    # 호스트 포트 노출하지 않음 (보안)
    expose:
      - "6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ===== 스토리지 레이어 =====

  # MinIO - S3 호환 오브젝트 스토리지
  minio:
    image: minio/minio:latest
    container_name: weavai_minio
    restart: unless-stopped
    networks:
      - weavai_network
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-weavai_admin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-change_this_long_random_password}
      MINIO_BROWSER: on  # 웹 콘솔 활성화
    volumes:
      - ${MINIO_DATA_DIR:-./minio-data}:/data  # 외장하드에 데이터 저장 (직접 경로 마운트)
    command: server /data --console-address ":9001"
    # 외부 공개 금지 - 127.0.0.1로만 바인딩
    ports:
      - "127.0.0.1:9000:9000"  # MinIO API
      - "127.0.0.1:9001:9001"  # MinIO Console (웹 UI)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 30s

  # ===== 애플리케이션 레이어 =====

  # Django API 서버
  api:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: weavai_api
    restart: unless-stopped
    networks:
      - weavai_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      # Django 설정
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG:-False}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1}
      # 데이터베이스
      POSTGRES_DB: ${POSTGRES_DB:-weavai}
      POSTGRES_USER: ${POSTGRES_USER:-weavai_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      # Redis/Celery (REDIS_URL은 Django cache·Celery 공용)
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      # MinIO 스토리지
      MINIO_ENDPOINT_URL: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-weavai_admin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET:-weavai-files}
      # AI 서비스
      FAL_KEY: ${FAL_KEY}
      FAL_TEXT_ENDPOINT: ${FAL_TEXT_ENDPOINT:-fal-ai/any-llm}
      FAL_TEXT_DEFAULT_MODEL: ${FAL_TEXT_DEFAULT_MODEL:-meta-llama/llama-4-maverick}
      FAL_IMAGE_MODEL_FLUX: ${FAL_IMAGE_MODEL_FLUX:-fal-ai/flux-2}
      FAL_IMAGE_MODEL_BANANA: ${FAL_IMAGE_MODEL_BANANA:-fal-ai/nano-banana-pro}
      FAL_VIDEO_MODEL_PRO: ${FAL_VIDEO_MODEL_PRO:-fal-ai/sora-2}
      # Firebase Admin
      FIREBASE_SERVICE_ACCOUNT_KEY_PATH: ${FIREBASE_SERVICE_ACCOUNT_KEY_PATH:-}
      AI_PROVIDER_DEFAULT: ${AI_PROVIDER_DEFAULT:-fal}
      MAX_TEXT_CHARS: ${MAX_TEXT_CHARS:-8000}
      MAX_OUTPUT_TOKENS: ${MAX_OUTPUT_TOKENS:-1024}
      # Billing (PortOne)
      USE_PORTONE: ${USE_PORTONE:-True}
      USE_STRIPE: ${USE_STRIPE:-False}
      PORTONE_API_SECRET: ${PORTONE_API_SECRET:-}
      PORTONE_WEBHOOK_SECRET: ${PORTONE_WEBHOOK_SECRET:-}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    volumes:
      - ../backend:/app
    # 디버그: Django 직접 접근을 위한 임시 호스트 포트 바인딩 (프로덕션에서는 제거)
    ports:
      - "127.0.0.1:8000:8000"
    # 호스트 포트 노출하지 않음 (Nginx를 통해서만 접근)
    expose:
      - "8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Celery Worker - 비동기 작업 처리
  worker:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: weavai_worker
    restart: unless-stopped
    networks:
      - weavai_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      # Django 설정
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG:-False}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1}
      # 데이터베이스
      POSTGRES_DB: ${POSTGRES_DB:-weavai}
      POSTGRES_USER: ${POSTGRES_USER:-weavai_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      # Redis/Celery (REDIS_URL은 Django cache·Celery 공용)
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      # MinIO 스토리지
      MINIO_ENDPOINT_URL: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-weavai_admin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET:-weavai-files}
      # AI 서비스
      FAL_KEY: ${FAL_KEY}
      FAL_TEXT_ENDPOINT: ${FAL_TEXT_ENDPOINT:-fal-ai/any-llm}
      FAL_TEXT_DEFAULT_MODEL: ${FAL_TEXT_DEFAULT_MODEL:-meta-llama/llama-4-maverick}
      FAL_IMAGE_MODEL_FLUX: ${FAL_IMAGE_MODEL_FLUX:-fal-ai/flux-2}
      FAL_IMAGE_MODEL_BANANA: ${FAL_IMAGE_MODEL_BANANA:-fal-ai/nano-banana-pro}
      FAL_VIDEO_MODEL_PRO: ${FAL_VIDEO_MODEL_PRO:-fal-ai/sora-2}
      # Firebase Admin
      FIREBASE_SERVICE_ACCOUNT_KEY_PATH: ${FIREBASE_SERVICE_ACCOUNT_KEY_PATH:-}
      AI_PROVIDER_DEFAULT: ${AI_PROVIDER_DEFAULT:-fal}
      MAX_TEXT_CHARS: ${MAX_TEXT_CHARS:-8000}
      MAX_OUTPUT_TOKENS: ${MAX_OUTPUT_TOKENS:-1024}
      # Billing (PortOne) - Celery task에서 결제 조회 API 호출용
      USE_PORTONE: ${USE_PORTONE:-True}
      PORTONE_API_SECRET: ${PORTONE_API_SECRET:-}
    volumes:
      - ../backend:/app
    command: celery -A weavai worker -l INFO --concurrency=4 -n celery@%h
    # 워커는 포트 노출하지 않음
    healthcheck:
      # Celery inspect ping으로 worker 생존 확인 (broker 왕복 검증)
      # -n celery@%h로 노드명 고정했으므로 -d celery@$$HOSTNAME으로 정확히 매칭
      test:
        [
          "CMD-SHELL",
          "celery -A weavai inspect ping -t 5 -d celery@$$HOSTNAME | grep -q pong || exit 1"
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===== 프론트엔드 레이어 =====

  # Nginx - 리버스 프록시 및 정적 파일 서빙
  nginx:
    image: nginx:alpine
    container_name: weavai_nginx
    restart: unless-stopped
    networks:
      - weavai_network
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "127.0.0.1:8080:80"  # 로컬 전용 바인딩 (외부 접근 비활성)
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro  # Nginx conf.d 전체 마운트
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
